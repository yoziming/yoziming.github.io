<!DOCTYPE html>
<html><head>
<meta name="google-site-verification" content="XrwF-xUZWSGJVBBm7jM8vqemVqx--zo5Tb9d-Vr7BCc" />
<title>Seataã€æ¶ˆæ¯éšŠåˆ—åˆ†ä½ˆå¼äº‹å‹™</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="SpringBootå¾®æœå‹™é …ç›®ç­†è¨˜-21">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="Seataã€æ¶ˆæ¯éšŠåˆ—åˆ†ä½ˆå¼äº‹å‹™" />
<meta property="og:description" content="SpringBootå¾®æœå‹™é …ç›®ç­†è¨˜-21" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yoziming.github.io/post/220207-gulimall-21-delay-queue/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-07T00:00:00+00:00" /><meta property="og:site_name" content="My Blog" />






<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Seataã€æ¶ˆæ¯éšŠåˆ—åˆ†ä½ˆå¼äº‹å‹™"/>
<meta name="twitter:description" content="SpringBootå¾®æœå‹™é …ç›®ç­†è¨˜-21"/>







<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  




<link rel="icon" href="https://yoziming.github.io/images/favicon.png">



<link rel="stylesheet" href="https://yoziming.github.io/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://yoziming.github.io/scss/dark-mode.min.f7c2efa7183435a6bd1842f91c541481c7a5137b5991629a870f24e4a516ad4b.css" integrity="sha256-98Lvpxg0Naa9GEL5HFQUgcelE3tZkWKahw8k5KUWrUs=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="/js/toc.js"></script>











<script src="//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js"></script>





</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://yoziming.github.io/">
    
        <div class="nav-title">
            æŸšå­èŒ¶å®¤
        </div>
        
        <div class="nav-subtitle">
            ç´€éŒ„è‡ªå­¸å¤§å°äº‹
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/">
                é¦–é ğŸ 
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                æ¨™ç±¤ğŸ·ï¸
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                ç³»åˆ—æ–‡ğŸ“–
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about-me">
                é—œæ–¼æˆ‘ğŸ£
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
ç§»æ¤è‡ª <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Yoziming
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- ç›®éŒ„ -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#spring-cloud-alibaba-seata" onclick="onNavClick(`#spring-cloud-alibaba-seata-nav`)" id="spring-cloud-alibaba-seata-nav">
									Spring cloud alibaba Seata
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%bb%b6%e9%81%b2%e9%9a%8a%e5%88%97" onclick="onNavClick(`#å»¶é²éšŠåˆ—-nav`)" id="å»¶é²éšŠåˆ—-nav">
									å»¶é²éšŠåˆ—
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%89%b5%e5%bb%ba%e9%9a%8a%e5%88%97%e8%88%87%e4%ba%a4%e6%8f%9b%e6%a9%9f" onclick="onNavClick(`#å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ-nav`)" id="å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ-nav">
									å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%8e%96%e5%ae%9a%e5%ba%ab%e5%ad%98" onclick="onNavClick(`#é–å®šåº«å­˜-nav`)" id="é–å®šåº«å­˜-nav">
									é–å®šåº«å­˜
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%a7%a3%e9%8e%96%e5%ba%ab%e5%ad%98" onclick="onNavClick(`#è§£é–åº«å­˜-nav`)" id="è§£é–åº«å­˜-nav">
									è§£é–åº«å­˜
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e7%99%bb%e5%85%a5%e6%94%94%e6%88%aa%e6%94%be%e8%a1%8c" onclick="onNavClick(`#ç™»å…¥æ””æˆªæ”¾è¡Œ-nav`)" id="ç™»å…¥æ””æˆªæ”¾è¡Œ-nav">
									ç™»å…¥æ””æˆªæ”¾è¡Œ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%97%9c%e9%96%89%e8%a8%82%e5%96%ae" onclick="onNavClick(`#é—œé–‰è¨‚å–®-nav`)" id="é—œé–‰è¨‚å–®-nav">
									é—œé–‰è¨‚å–®
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bf%ae%e5%be%a9bug" onclick="onNavClick(`#ä¿®å¾©bug-nav`)" id="ä¿®å¾©bug-nav">
									ä¿®å¾©BUG
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%8f%af%e9%9d%a0%e6%80%a7" onclick="onNavClick(`#å¯é æ€§-nav`)" id="å¯é æ€§-nav">
									å¯é æ€§
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%98%b2%e6%ad%a2%e6%b6%88%e6%81%af%e4%b8%9f%e5%a4%b1" onclick="onNavClick(`#é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±-nav`)" id="é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±-nav">
									é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%98%b2%e6%ad%a2%e6%b6%88%e6%81%af%e9%87%8d%e8%a4%87" onclick="onNavClick(`#é˜²æ­¢æ¶ˆæ¯é‡è¤‡-nav`)" id="é˜²æ­¢æ¶ˆæ¯é‡è¤‡-nav">
									é˜²æ­¢æ¶ˆæ¯é‡è¤‡
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%98%b2%e6%ad%a2%e6%b6%88%e6%81%af%e7%a9%8d%e5%a3%93" onclick="onNavClick(`#é˜²æ­¢æ¶ˆæ¯ç©å£“-nav`)" id="é˜²æ­¢æ¶ˆæ¯ç©å£“-nav">
									é˜²æ­¢æ¶ˆæ¯ç©å£“
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%b0%8f%e7%b5%90" onclick="onNavClick(`#å°çµ-nav`)" id="å°çµ-nav">
									å°çµ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#feign%e8%aa%bf%e7%94%a8%e5%a0%b1%e9%8c%af400-bad-reques" onclick="onNavClick(`#feignèª¿ç”¨å ±éŒ¯400-bad-reques-nav`)" id="feignèª¿ç”¨å ±éŒ¯400-bad-reques-nav">
									Feignèª¿ç”¨å ±éŒ¯400 Bad Reques
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/">
                    é¦–é ğŸ 
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    æ¨™ç±¤ğŸ·ï¸
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    ç³»åˆ—æ–‡ğŸ“–
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about-me">
                    é—œæ–¼æˆ‘ğŸ£
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- ç›®éŒ„ -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#spring-cloud-alibaba-seata" onclick="onNavClick(`#spring-cloud-alibaba-seata-nav`)" id="spring-cloud-alibaba-seata-nav">
									Spring cloud alibaba Seata
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%bb%b6%e9%81%b2%e9%9a%8a%e5%88%97" onclick="onNavClick(`#å»¶é²éšŠåˆ—-nav`)" id="å»¶é²éšŠåˆ—-nav">
									å»¶é²éšŠåˆ—
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%89%b5%e5%bb%ba%e9%9a%8a%e5%88%97%e8%88%87%e4%ba%a4%e6%8f%9b%e6%a9%9f" onclick="onNavClick(`#å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ-nav`)" id="å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ-nav">
									å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%8e%96%e5%ae%9a%e5%ba%ab%e5%ad%98" onclick="onNavClick(`#é–å®šåº«å­˜-nav`)" id="é–å®šåº«å­˜-nav">
									é–å®šåº«å­˜
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%a7%a3%e9%8e%96%e5%ba%ab%e5%ad%98" onclick="onNavClick(`#è§£é–åº«å­˜-nav`)" id="è§£é–åº«å­˜-nav">
									è§£é–åº«å­˜
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e7%99%bb%e5%85%a5%e6%94%94%e6%88%aa%e6%94%be%e8%a1%8c" onclick="onNavClick(`#ç™»å…¥æ””æˆªæ”¾è¡Œ-nav`)" id="ç™»å…¥æ””æˆªæ”¾è¡Œ-nav">
									ç™»å…¥æ””æˆªæ”¾è¡Œ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%97%9c%e9%96%89%e8%a8%82%e5%96%ae" onclick="onNavClick(`#é—œé–‰è¨‚å–®-nav`)" id="é—œé–‰è¨‚å–®-nav">
									é—œé–‰è¨‚å–®
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bf%ae%e5%be%a9bug" onclick="onNavClick(`#ä¿®å¾©bug-nav`)" id="ä¿®å¾©bug-nav">
									ä¿®å¾©BUG
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%8f%af%e9%9d%a0%e6%80%a7" onclick="onNavClick(`#å¯é æ€§-nav`)" id="å¯é æ€§-nav">
									å¯é æ€§
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%98%b2%e6%ad%a2%e6%b6%88%e6%81%af%e4%b8%9f%e5%a4%b1" onclick="onNavClick(`#é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±-nav`)" id="é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±-nav">
									é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%98%b2%e6%ad%a2%e6%b6%88%e6%81%af%e9%87%8d%e8%a4%87" onclick="onNavClick(`#é˜²æ­¢æ¶ˆæ¯é‡è¤‡-nav`)" id="é˜²æ­¢æ¶ˆæ¯é‡è¤‡-nav">
									é˜²æ­¢æ¶ˆæ¯é‡è¤‡
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%98%b2%e6%ad%a2%e6%b6%88%e6%81%af%e7%a9%8d%e5%a3%93" onclick="onNavClick(`#é˜²æ­¢æ¶ˆæ¯ç©å£“-nav`)" id="é˜²æ­¢æ¶ˆæ¯ç©å£“-nav">
									é˜²æ­¢æ¶ˆæ¯ç©å£“
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%b0%8f%e7%b5%90" onclick="onNavClick(`#å°çµ-nav`)" id="å°çµ-nav">
									å°çµ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#feign%e8%aa%bf%e7%94%a8%e5%a0%b1%e9%8c%af400-bad-reques" onclick="onNavClick(`#feignèª¿ç”¨å ±éŒ¯400-bad-reques-nav`)" id="feignèª¿ç”¨å ±éŒ¯400-bad-reques-nav">
									Feignèª¿ç”¨å ±éŒ¯400 Bad Reques
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://yoziming.github.io/">
            æŸšå­èŒ¶å®¤
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://yoziming.github.io/">
        <div class="single-column-header-title">æŸšå­èŒ¶å®¤</div>
        
        <div class="single-column-header-subtitle">ç´€éŒ„è‡ªå­¸å¤§å°äº‹</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://yoziming.github.io/images/seata.png')"
                    
                
            >
                <div class="post-title">
                    Seataã€æ¶ˆæ¯éšŠåˆ—åˆ†ä½ˆå¼äº‹å‹™
                    
                    <div class="post-subtitle">
                        SpringBootå¾®æœå‹™é …ç›®ç­†è¨˜-21
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-02-07 00:00
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/java%E5%BE%AE%E6%9C%8D%E5%8B%99%E5%B0%88%E6%A1%88">Javaå¾®æœå‹™å°ˆæ¡ˆ</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/java">Java</a>
                                &nbsp;
                            
                                <a href="/tags/mq">MQ</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="spring-cloud-alibaba-seata">Spring cloud alibaba Seata</h1>
<ul>
<li>æœ‰å¾ˆå¤šæ¨¡å¼ï¼Œé€™é‚Šåªæ¼”ç¤ºæœ€ç°¡å–®çš„ATæ¨¡å¼</li>
<li>ç°¡å–®ä¾†èªªå°±æ˜¯å¤šåŒ…ä¸€å±¤ï¼Œé¡å¤–é–‹ä¸€å€‹ä¼ºæœå™¨å»ç›£æ§å¤šå€‹åˆ†ä½ˆå¼æ¨¡çµ„ï¼Œèª°å‡ºå•é¡Œå°±è®“å¤§å®¶éƒ½å›æ»¾</li>
</ul>
<p><img src="image-20220130172819564.png" alt="image-20220130172819564"></p>
<ul>
<li>
<p>ä½¿ç”¨<code>@GlobalTransactional</code>å°±å¯ä»¥é”æˆåˆ†ä½ˆå¼äº‹å‹™</p>
</li>
<li>
<p>åˆ©ç”¨çš„æ©Ÿåˆ¶æ˜¯åœ¨DBå¢åŠ ä¸€å€‹undo_logè¡¨ï¼Œé€™å€‹è¡¨ç›¸ç•¶æ–¼å­˜å¿«ç…§çš„åœ°æ–¹ï¼Œç•¶è¦å›æ»¾å°±å¾é€™é‚Šé‚„åŸ</p>
<ul>
<li>ATæ¨¡å¼ç°¡å–®ï¼Œä»£åƒ¹å°±æ˜¯é¢å°ä½µç™¼æ•ˆç‡ä¸é«˜</li>
</ul>
</li>
<li>
<p>é€™ç©æ„æ‰å¹¾å€‹ç‰ˆæœ¬è¨­å®šå°±è®Šå¥½å¤šæ¬¡ï¼Œå…·é«”ä½¿ç”¨é‚„æ˜¯çœ‹å®˜ç¶²å§</p>
<ul>
<li><a href="https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html">https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html</a></li>
</ul>
</li>
</ul>
<h1 id="å»¶é²éšŠåˆ—">å»¶é²éšŠåˆ—</h1>
<blockquote>
<p>Delay Queueï¼Œä½¿ç”¨ æ¶ˆæ¯éšŠåˆ— + åº«å­˜å·¥ä½œå–®è¡¨ ä¾†æ§åˆ¶åˆ†ä½ˆå¼äº‹å‹™</p>
</blockquote>
<ul>
<li>ä¸‹è¨‚å–®å¾Œï¼Œè¦é–å®šåº«å­˜ï¼Œé€™æ˜¯å€‹åˆ†ä½ˆå¼äº‹å‹™ï¼Œéœ€è¦ä¿è­‰é–å®šçš„åº«å­˜èƒ½å›æ»¾ï¼Œé¦–å…ˆåœ¨DBä½¿ç”¨å…©å¼µè¡¨</li>
<li><code>wms_ware_order_task</code> åº«å­˜å·¥ä½œå–®è¡¨ï¼Œè¨‚å–®ã€å·¥ä½œå–®idã€å€‰åº«id</li>
<li><code>wms_ware_order_task_detail</code> åº«å­˜å·¥ä½œå–®è©³æƒ…è¡¨ï¼Œè¨‚å–®ã€å·¥ä½œå–®idã€å€‰åº«idã€skuIdã€é–åº«å­˜æ•¸é‡</li>
<li>é–åº«å­˜çš„æ™‚å€™å¾€å·¥ä½œå–®è¡¨ã€å·¥ä½œå–®è©³æƒ…è¡¨æ’å…¥æ•¸æ“š</li>
</ul>
<p><img src="image-20220130203619038.png" alt="image-20220130203619038"></p>
<h2 id="å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ">å‰µå»ºéšŠåˆ—èˆ‡äº¤æ›æ©Ÿ</h2>
<blockquote>
<p>åœ¨RabbitMQ</p>
</blockquote>
<ul>
<li>å‰µå»ºè¨‚å–®æ™‚ï¼Œé ç¨‹èª¿ç”¨<code>orderLockStock</code>å‰µå»ºäº†åº«å­˜å·¥ä½œå–®ï¼Œä¸¦ä¸”é–å®šåº«å­˜
<ul>
<li>é‚£é‚Šç™¼äº†<code>&quot;stock-event-exchange&quot;, &quot;stock.locked&quot;, lockedTo</code>ï¼ŒlockedToè£¡é¢å°±æ˜¯åº«å­˜å·¥ä½œå–®id</li>
</ul>
</li>
<li>ç•¶é ç¨‹èª¿ç”¨å‰µå»ºåº«å­˜å·¥ä½œå–®æˆåŠŸï¼Œæœ¬åœ°ä¹Ÿç™¼ä¸€å€‹<code>&quot;order-event-exchange&quot;, &quot;order.create.order&quot;</code>ï¼Œè£¡é¢å­˜çš„æ˜¯è¨‚å–®æœ¬é«”</li>
</ul>
<p><img src="image-20220130195011045.png" alt="image-20220130195011045"></p>
<ul>
<li>æ”¹è‰¯ï¼Œçœä¸‹ä¸€å€‹äº¤æ›æ©Ÿï¼Œå¸¶æœ‰<code>&quot;order.create.order&quot;</code>è·¯ç”±éµçš„è¨‚å–®æœƒé€²åˆ°<code>order.delay.queue</code>é€™å€‹å»¶é²éšŠåˆ—ï¼Œè€Œé€™å€‹éšŠåˆ—é‚„æ˜¯æŒ‡å‘<code>order-event-exchange</code>äº¤æ›æ©Ÿ</li>
<li>ä½†æ˜¯ä»–è¨­æœ‰éæœŸæ™‚é–“ï¼Œç•¶æ™‚é–“åˆ°äº†å°±æŠŠè·¯ç”±éµæ›æˆ<code>order.release.order</code></li>
<li>ä¹Ÿå°±æ˜¯èªªï¼Œæ‰€æœ‰çš„è¨‚å–®æœ€çµ‚éƒ½æœƒé€²åˆ°<code>order.release.order.queue</code>ï¼Œä¸¦ä¸”è¢«<code>listener</code>æ¶ˆè²»ï¼Œé€™å€‹<code>listener</code>æœƒèª¿ç”¨<code>closeOrder</code>æ–¹æ³•</li>
<li><code>closeOrder</code>æ–¹æ³•æŸ¥çœ‹è¨‚å–®æ˜¯å¦å·²ç¶“æ”¯ä»˜ï¼Œè‹¥å·²æ”¯ä»˜å°±å®Œäº‹ï¼Œè¨‚å–®å¯ä»¥å®‰å¿ƒé›¢é–‹éšŠåˆ—ã€‚è‹¥æ²’æ”¯ä»˜å°±æŸ¥è©¢è¨‚å–®æœ€æ–°ç‹€æ…‹ï¼Œå†ç™¼åˆ°<code>&quot;order-event-exchange&quot;, &quot;order.release.other.unlock&quot;, order</code></li>
<li>é€™å€‹<code>&quot;order.release.other.unlock&quot;</code>è·¯ç”±éµå°±æœƒæŠŠè¨‚å–®é€åˆ°<code>stock.release.stock.queue</code>ï¼Œå˜—è©¦é€²è¡Œåº«å­˜è§£é–çš„å‹•ä½œ</li>
</ul>
<p><img src="image-20220130195221065.png" alt="image-20220130195221065"></p>
<ul>
<li>ä¹‹å‰å­¸äº†ç”¨AmqpAdminå‰µå»ºäº¤æ›æ©Ÿèˆ‡éšŠåˆ—çš„æ–¹æ³•ï¼Œæœ‰æ›´çœäº‹çš„å¯ä»¥ç›´æ¥ç”¨<code>@Bean</code>è®“springè‡ªå‹•å‰µå»º
<ul>
<li>Brokerä¸­æ²’æœ‰è©²åå­—çš„éšŠåˆ—ã€äº¤æ›æ©Ÿæ‰æœƒå‰µå»º</li>
<li>ä¸æœƒé‡è¤‡å‰µå»ºè¦†è“‹(ä¸€æ—¦å‰µå¥½ï¼Œä¸èƒ½æ›´æ–°)ï¼Œå¦‚æœåŒåçš„éšŠåˆ—å…¶ä¸­è¨­å®š(ä¾‹å¦‚éæœŸæ™‚é–“)å°ä¸ä¸Šæœƒå ±éŒ¯</li>
<li>ç¬¬ä¸€æ¬¡ä½¿ç”¨éšŠåˆ—çš„æ™‚å€™æ‰æœƒå‰µå»º</li>
</ul>
</li>
<li>MyMQConfig.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">MyMQConfig</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">// å»¶é²éšŠåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> Queue <span style="color:#008b45">orderDelayQueue</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">        Queue(String name,  éšŠåˆ—åå­—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">        boolean durable,  æ˜¯å¦æŒä¹…åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">        boolean exclusive,  æ˜¯å¦æ’ä»–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">        boolean autoDelete, æ˜¯å¦è‡ªå‹•åˆªé™¤
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">        Map&lt;String, Object&gt; arguments) å±¬æ€§ã€TTLã€æ­»ä¿¡è·¯ç”±ã€æ­»ä¿¡è·¯ç”±éµã€‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    HashMap&lt;String, Object&gt; arguments = <span style="color:#8b008b;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    arguments.<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;x-dead-letter-exchange&#34;</span>, <span style="color:#cd5555">&#34;order-event-exchange&#34;</span>);<span style="color:#228b22">// æ­»ä¿¡è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    arguments.<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;x-dead-letter-routing-key&#34;</span>, <span style="color:#cd5555">&#34;order.release.order&#34;</span>);<span style="color:#228b22">// æ­»ä¿¡è·¯ç”±éµ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    arguments.<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;x-message-ttl&#34;</span>, 60000); <span style="color:#228b22">// æ¶ˆæ¯éæœŸæ™‚é–“ 1åˆ†é˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    Queue queue = <span style="color:#8b008b;font-weight:bold">new</span> Queue(<span style="color:#cd5555">&#34;order.delay.queue&#34;</span>, <span style="color:#8b008b;font-weight:bold">true</span>, <span style="color:#8b008b;font-weight:bold">false</span>, <span style="color:#8b008b;font-weight:bold">false</span>, arguments);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> queue;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">// æ­»ä¿¡éšŠåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> Queue <span style="color:#008b45">orderReleaseQueue</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">new</span> Queue(<span style="color:#cd5555">&#34;order.release.order.queue&#34;</span>, <span style="color:#8b008b;font-weight:bold">true</span>, <span style="color:#8b008b;font-weight:bold">false</span>, <span style="color:#8b008b;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">// æ™®é€šè·¯ç”±ã€æ­»ä¿¡è·¯ç”±ã€‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> Exchange <span style="color:#008b45">orderEventExchange</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *   String name,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *   boolean durable,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *   boolean autoDelete,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *   Map&lt;String, Object&gt; arguments
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">new</span> TopicExchange(<span style="color:#cd5555">&#34;order-event-exchange&#34;</span>, <span style="color:#8b008b;font-weight:bold">true</span>, <span style="color:#8b008b;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">// äº¤æ›æ©Ÿèˆ‡å»¶é²éšŠåˆ—çš„ç¶å®š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> Binding <span style="color:#008b45">orderCreateBinding</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * String destination, ç›®çš„åœ°ï¼ˆéšŠåˆ—åæˆ–è€…äº¤æ›æ©Ÿåå­—ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * DestinationType destinationType, ç›®çš„åœ°é¡å‹ï¼ˆQueueã€Exhcangeï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * String exchange,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * String routingKey,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * Map&lt;String, Object&gt; arguments
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">new</span> Binding(<span style="color:#cd5555">&#34;order.delay.queue&#34;</span>,
</span></span><span style="display:flex;"><span>            Binding.<span style="color:#658b00">DestinationType</span>.<span style="color:#658b00">QUEUE</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;order-event-exchange&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;order.create.order&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">// æ­»ä¿¡è·¯ç”±èˆ‡æ™®é€šéšŠåˆ—çš„ç¶å®š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> Binding <span style="color:#008b45">orderReleaseBinding</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">new</span> Binding(<span style="color:#cd5555">&#34;order.release.order.queue&#34;</span>,
</span></span><span style="display:flex;"><span>            Binding.<span style="color:#658b00">DestinationType</span>.<span style="color:#658b00">QUEUE</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;order-event-exchange&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;order.release.order&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">// è¨‚å–®é‡‹æ”¾ç›´æ¥å’Œåº«å­˜é‡‹æ”¾é€²è¡Œç¶å®š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> Binding <span style="color:#008b45">orderReleaseOtherBinding</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">new</span> Binding(<span style="color:#cd5555">&#34;stock.release.stock.queue&#34;</span>,
</span></span><span style="display:flex;"><span>            Binding.<span style="color:#658b00">DestinationType</span>.<span style="color:#658b00">QUEUE</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;order-event-exchange&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;order.release.other.#&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>åº«å­˜å€çš„MQ</li>
</ul>
<p><img src="image-20220130201936776.png" alt="image-20220130201936776"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * åº«å­˜æœå‹™é è¨­çš„äº¤æ›æ©Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> Exchange <span style="color:#008b45">stockEventExchange</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        TopicExchange topicExchange = <span style="color:#8b008b;font-weight:bold">new</span> TopicExchange(<span style="color:#cd5555">&#34;stock-event-exchange&#34;</span>, <span style="color:#8b008b;font-weight:bold">true</span>, <span style="color:#8b008b;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> topicExchange;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * æ™®é€šéšŠåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> Queue <span style="color:#008b45">stockReleaseStockQueue</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        Queue queue = <span style="color:#8b008b;font-weight:bold">new</span> Queue(<span style="color:#cd5555">&#34;stock.release.stock.queue&#34;</span>, <span style="color:#8b008b;font-weight:bold">true</span>, <span style="color:#8b008b;font-weight:bold">false</span>, <span style="color:#8b008b;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> queue;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * å»¶é²éšŠåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> Queue <span style="color:#008b45">stockDelay</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap&lt;String, Object&gt; arguments = <span style="color:#8b008b;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        arguments.<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;x-dead-letter-exchange&#34;</span>, <span style="color:#cd5555">&#34;stock-event-exchange&#34;</span>);
</span></span><span style="display:flex;"><span>        arguments.<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;x-dead-letter-routing-key&#34;</span>, <span style="color:#cd5555">&#34;stock.release&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// æ¶ˆæ¯éæœŸæ™‚é–“ 2åˆ†é˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        arguments.<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;x-message-ttl&#34;</span>, 120000);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Queue queue = <span style="color:#8b008b;font-weight:bold">new</span> Queue(<span style="color:#cd5555">&#34;stock.delay.queue&#34;</span>, <span style="color:#8b008b;font-weight:bold">true</span>, <span style="color:#8b008b;font-weight:bold">false</span>, <span style="color:#8b008b;font-weight:bold">false</span>, arguments);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> queue;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * äº¤æ›æ©Ÿèˆ‡æ™®é€šéšŠåˆ—ç¶å®š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> Binding <span style="color:#008b45">stockLocked</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//String destination, DestinationType destinationType, String exchange, String routingKey,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#228b22">// 			Map&lt;String, Object&gt; arguments
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        Binding binding = <span style="color:#8b008b;font-weight:bold">new</span> Binding(<span style="color:#cd5555">&#34;stock.release.stock.queue&#34;</span>,
</span></span><span style="display:flex;"><span>                Binding.<span style="color:#658b00">DestinationType</span>.<span style="color:#658b00">QUEUE</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cd5555">&#34;stock-event-exchange&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cd5555">&#34;stock.release.#&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> binding;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * äº¤æ›æ©Ÿèˆ‡å»¶é²éšŠåˆ—ç¶å®š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> Binding <span style="color:#008b45">stockLockedBinding</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">new</span> Binding(<span style="color:#cd5555">&#34;stock.delay.queue&#34;</span>,
</span></span><span style="display:flex;"><span>                Binding.<span style="color:#658b00">DestinationType</span>.<span style="color:#658b00">QUEUE</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cd5555">&#34;stock-event-exchange&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cd5555">&#34;stock.locked&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="é–å®šåº«å­˜">é–å®šåº«å­˜</h3>
<blockquote>
<p>é–å®šæˆåŠŸçµ¦mqç™¼é€ä¸€æ¢æ¶ˆæ¯</p>
</blockquote>
<ul>
<li>
<p>åº«å­˜è§£é–çš„å¹¾ç¨®æƒ…æ³ï¼š</p>
<ul>
<li>ä¸‹è¨‚å–®æˆåŠŸï¼Œåº«å­˜é–å®šæˆåŠŸï¼Œè¨‚å–®éæœŸæ²’æœ‰æ”¯ä»˜è¢«ç³»çµ±è‡ªå‹•å–æ¶ˆã€è¢«ç”¨æˆ·æ‰‹å‹•å–æ¶ˆ</li>
<li>ä¸‹è¨‚å–®æˆåŠŸï¼Œåº«å­˜é–å®šæˆåŠŸï¼Œæ¥ä¸‹ä¾†çš„æ¥­å‹™èª¿ç”¨å¤±æ•—ï¼Œå°è‡´è¨‚å–®å›æ»¾ã€‚</li>
</ul>
</li>
<li>
<p>è§£æ</p>
<ul>
<li>ä¸€å€‹è¨‚å–®å°æ‡‰wms_ware_order_taskå·¥ä½œå–®è¡¨ä¸€æ¢æ•¸æ“šï¼Œå°æ‡‰ä¸€æ¢å·¥ä½œå–®task_id</li>
<li>ä¸€æ¢å·¥ä½œå–®task_idå°æ‡‰å¤šæ¢è©³æƒ…sku_idï¼Œware_id</li>
</ul>
</li>
<li>
<p>serviceæ–¹æ³•æµç¨‹</p>
<ul>
<li>ä¿å­˜ä¸€æ¢å·¥ä½œå–®åˆ°wms_ware_order_task</li>
<li>å¦‚æœåº«å­˜é–å®šæˆåŠŸï¼Œå€‰åº«åº«å­˜è¶³å¤ ï¼Œå°±ç‚ºç•¶å‰å•†å“æ’å…¥ä¸€æ¢å·¥ä½œå–®è©³æƒ…</li>
<li>å¦‚æœæœ‰ä»»ä¸€å•†å“åº«å­˜ä¸è¶³ï¼Œå°±å›æ»¾</li>
<li>å¦‚æœæœ‰åº«å­˜ï¼Œå°±ç™¼é€æ¶ˆæ¯åˆ°mqçš„å»¶æ™‚éšŠåˆ—ï¼Œä¸€å€‹å•†å“ä¸€æ¢ä¿¡æ¯StockLockedToï¼Œæ•¸é‡ä¿¡æ¯å¿…é ˆå¸¶ä¸Šï¼Œå› ç‚ºå¦‚æœå›æ»¾äº†dbå°±æŸ¥ä¸åˆ°æ•¸æ“šäº†</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * ç‚ºæŸå€‹è¨‚å–®é–å®šåº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Transactional</span>(rollbackFor = Exception.<span style="color:#658b00">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">boolean</span> <span style="color:#008b45">orderLockStock</span>(WareSkuLockVo vo) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * ä¿å­˜åº«å­˜å·¥ä½œå–®è©³æƒ…ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * è¿½æº¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * å¦‚æœæ²’æœ‰åº«å­˜ï¼Œå°±ä¸æœƒç™¼é€æ¶ˆæ¯çµ¦mq
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * ã€ä¸æœƒé€²å…¥save(WareOrderTaskDetailEntity)é‚è¼¯ï¼Œä¹Ÿä¸æœƒç™¼é€æ¶ˆæ¯çµ¦mqï¼Œä¹Ÿä¸æœƒé–å®šåº«å­˜ï¼Œä¹Ÿä¸æœƒç›£è½åˆ°è§£é–æœå‹™ã€‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    WareOrderTaskEntity wareOrderTaskEntity = <span style="color:#8b008b;font-weight:bold">new</span> WareOrderTaskEntity();
</span></span><span style="display:flex;"><span>    wareOrderTaskEntity.<span style="color:#658b00">setOrderSn</span>(vo.<span style="color:#658b00">getOrderSn</span>());
</span></span><span style="display:flex;"><span>    wareOrderTaskEntity.<span style="color:#658b00">setCreateTime</span>(<span style="color:#8b008b;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>    wareOrderTaskService.<span style="color:#658b00">save</span>(wareOrderTaskEntity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//1ã€æŒ‰ç…§ä¸‹å–®çš„æ”¶è²¨åœ°å€ï¼Œæ‰¾åˆ°ä¸€å€‹å°±è¿‘å€‰åº«ï¼Œé–å®šåº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">//2ã€æ‰¾åˆ°æ¯å€‹å•†å“åœ¨å“ªå€‹å€‰åº«éƒ½æœ‰åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;OrderItemVo&gt; locks = vo.<span style="color:#658b00">getLocks</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    List&lt;SkuWareHasStock&gt; collect = locks.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>((item) -&gt; {
</span></span><span style="display:flex;"><span>        SkuWareHasStock stock = <span style="color:#8b008b;font-weight:bold">new</span> SkuWareHasStock();
</span></span><span style="display:flex;"><span>        Long skuId = item.<span style="color:#658b00">getSkuId</span>();
</span></span><span style="display:flex;"><span>        stock.<span style="color:#658b00">setSkuId</span>(skuId);
</span></span><span style="display:flex;"><span>        stock.<span style="color:#658b00">setNum</span>(item.<span style="color:#658b00">getCount</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//æŸ¥è©¢é€™å€‹å•†å“åœ¨å“ªå€‹å€‰åº«æœ‰åº«å­˜ stock-é–å®šnum &gt; 0
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        List&lt;Long&gt; wareIdList = wareSkuDao.<span style="color:#658b00">listWareIdHasSkuStock</span>(skuId);
</span></span><span style="display:flex;"><span>        stock.<span style="color:#658b00">setWareId</span>(wareIdList);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> stock;
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//2ã€é–å®šåº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">for</span> (SkuWareHasStock hasStock : collect) {
</span></span><span style="display:flex;"><span>        <span style="color:#00688b;font-weight:bold">boolean</span> skuStocked = <span style="color:#8b008b;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>        Long skuId = hasStock.<span style="color:#658b00">getSkuId</span>();
</span></span><span style="display:flex;"><span>        List&lt;Long&gt; wareIds = hasStock.<span style="color:#658b00">getWareId</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (CollectionUtils.<span style="color:#658b00">isEmpty</span>(wareIds)) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//æ²’æœ‰ä»»ä½•å€‰åº«æœ‰é€™å€‹å•†å“çš„åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">throw</span> <span style="color:#8b008b;font-weight:bold">new</span> NoStockException(skuId);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//1ã€å¦‚æœæ¯ä¸€å€‹å•†å“éƒ½é–å®šæˆåŠŸ,å°‡ç•¶å‰å•†å“é–å®šäº†å¹¾ä»¶çš„å·¥ä½œå–®è¨˜éŒ„ç™¼çµ¦MQ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#228b22">//2ã€é–å®šå¤±æ•—ã€‚å‰é¢ä¿å­˜çš„å·¥ä½œå–®ä¿¡æ¯éƒ½å›æ»¾äº†ã€‚ç™¼é€å‡ºå»çš„æ¶ˆæ¯ï¼Œå³ä½¿è¦è§£é–åº«å­˜ï¼Œç”±æ–¼åœ¨æ•¸æ“šåº«æŸ¥ä¸åˆ°æŒ‡å®šçš„idï¼Œå°±ä¸ç”¨è§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">for</span> (Long wareId : wareIds) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//é–å®šæˆåŠŸå°±è¿”å›1ï¼Œå¤±æ•—å°±è¿”å›0
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            Long count = wareSkuDao.<span style="color:#658b00">lockSkuStock</span>(skuId, wareId, hasStock.<span style="color:#658b00">getNum</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// count==1è¡¨ç¤ºé–å®šæˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">if</span> (count == 1) {
</span></span><span style="display:flex;"><span>                skuStocked = <span style="color:#8b008b;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>                WareOrderTaskDetailEntity taskDetailEntity = WareOrderTaskDetailEntity.<span style="color:#658b00">builder</span>()
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">skuId</span>(skuId)
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">skuName</span>(<span style="color:#cd5555">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">skuNum</span>(hasStock.<span style="color:#658b00">getNum</span>())
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">taskId</span>(wareOrderTaskEntity.<span style="color:#658b00">getId</span>())
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">wareId</span>(wareId)
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">lockStatus</span>(1)
</span></span><span style="display:flex;"><span>                        .<span style="color:#658b00">build</span>();
</span></span><span style="display:flex;"><span>                wareOrderTaskDetailService.<span style="color:#658b00">save</span>(taskDetailEntity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">// å‘Šè¨´MQåº«å­˜é–å®šæˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                StockLockedTo lockedTo = <span style="color:#8b008b;font-weight:bold">new</span> StockLockedTo();
</span></span><span style="display:flex;"><span>                lockedTo.<span style="color:#658b00">setId</span>(wareOrderTaskEntity.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>                StockDetailTo detailTo = <span style="color:#8b008b;font-weight:bold">new</span> StockDetailTo();
</span></span><span style="display:flex;"><span>                BeanUtils.<span style="color:#658b00">copyProperties</span>(taskDetailEntity, detailTo);<span style="color:#228b22">// é€™è£ç›´æ¥å­˜entityã€‚ä½†æ˜¯æ‡‰è©²å­˜idæ›´å¥½ï¼Œæ•¸æ“šæœ€å¥½ä¾†è‡ªDB
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                lockedTo.<span style="color:#658b00">setDetailTo</span>(detailTo);
</span></span><span style="display:flex;"><span>                rabbitTemplate.<span style="color:#658b00">convertAndSend</span>(<span style="color:#cd5555">&#34;stock-event-exchange&#34;</span>, <span style="color:#cd5555">&#34;stock.locked&#34;</span>, lockedTo);
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">// é–å®šæˆåŠŸè¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#8b008b;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">//ç•¶å‰å€‰åº«é–å¤±æ•—ï¼Œé‡è©¦ä¸‹ä¸€å€‹å€‰åº«
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (skuStocked == <span style="color:#8b008b;font-weight:bold">false</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//ç•¶å‰å•†å“æ‰€æœ‰å€‰åº«éƒ½æ²’æœ‰é–ä½
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">throw</span> <span style="color:#8b008b;font-weight:bold">new</span> NoStockException(skuId);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//3ã€è‚¯å®šå…¨éƒ¨éƒ½æ˜¯é–å®šæˆåŠŸçš„
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="è§£é–åº«å­˜">è§£é–åº«å­˜</h3>
<blockquote>
<p>ä¸ä½¿ç”¨åˆ†ä½ˆå¼äº‹å‹™ï¼Œæ¯ä¸€å€‹sku ç”¢ç”Ÿä¸€æ¢æ¶ˆæ¯</p>
</blockquote>
<ul>
<li>
<p>åº«å­˜é–å®šæˆåŠŸï¼Œä½†æ˜¯è¨‚å–®serviceå›æ»¾äº†ï¼Œæ­¤æ™‚éœ€è¦è§£é–</p>
</li>
<li>
<p>if(dbå·¥ä½œå–®è©³æƒ…æœ‰æ•¸æ“š)ï¼šåº«å­˜é–å®šæˆåŠŸï¼ŒæŒ‰ç…§è¨‚å–®è™ŸæŸ¥è©¢è¨‚å–®</p>
<ul>
<li>
<p>è¨‚å–®ä¸å­˜åœ¨ï¼Œé‚£å°±æ˜¯è¨‚å–®service å›æ»¾äº†ã€è§£é–åº«å­˜ã€‘</p>
</li>
<li>
<p>è¨‚å–®å­˜åœ¨:</p>
<ul>
<li>è¨‚å–®ç‹€æ…‹ï¼šå·²å–æ¶ˆï¼Œã€è§£é–åº«å­˜ã€‘</li>
<li>è¨‚å–®ç‹€æ…‹ï¼šæœªå–æ¶ˆï¼Œã€ä¸è§£é–ã€‘</li>
</ul>
</li>
</ul>
</li>
<li>
<p>else(dbå·¥ä½œå–®è©³æƒ…ç„¡æ•¸æ“š)ï¼šå·²å›æ»¾ï¼Œã€ä¸è§£é–ã€‘å·¥ä½œå–®èˆ‡åº«å­˜åœ¨ä¸€å€‹æœ¬åœ°äº‹å‹™ä¸­</p>
</li>
<li>
<p>è§£é–é‚è¼¯ï¼š</p>
<ul>
<li>åº«å­˜åŠ å›ä¾†ï¼Œé–å®šåº«å­˜æ•¸é‡æ¸›æ‰</li>
<li>å°‡å·¥ä½œå–®è©³æƒ…çš„ç‹€æ…‹ä¿®æ”¹ç‚ºå·²è§£é–</li>
<li>å¦‚æœè§£é–æˆåŠŸï¼Œç°½æ”¶æ¶ˆæ¯ï¼Œå¦‚æœæœªè§£é–æˆåŠŸæ‹’çµ•æ¶ˆæ¯ã€æ‰‹å‹•æ¨¡å¼ã€‘
<ul>
<li>requeue trueé‡æ–°å…¥éšŠï¼Œè®“å…¶ä»–ç¯€é»å˜—è©¦è§£é–</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * è§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">unlockStock</span>(StockLockedTo to) {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//åº«å­˜å·¥ä½œå–®çš„id
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    StockDetailTo detail = to.<span style="color:#658b00">getDetailTo</span>();
</span></span><span style="display:flex;"><span>    Long detailId = detail.<span style="color:#658b00">getId</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * è§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * 1ã€æŸ¥è©¢æ•¸æ“šåº«é—œæ–¼é€™å€‹è¨‚å–®é–å®šåº«å­˜ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *   æœ‰ï¼šè­‰æ˜åº«å­˜é–å®šæˆåŠŸäº†
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *      è§£é–ï¼šè¨‚å–®ç‹€æ³
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *          1ã€æ²’æœ‰é€™å€‹è¨‚å–®ï¼Œå¿…é ˆè§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *          2ã€æœ‰é€™å€‹è¨‚å–®ï¼Œä¸ä¸€å®šè§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *              è¨‚å–®ç‹€æ…‹ï¼šå·²å–æ¶ˆï¼šè§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     *                      å·²æ”¯ä»˜ï¼šä¸èƒ½è§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    WareOrderTaskDetailEntity taskDetailInfo = wareOrderTaskDetailService.<span style="color:#658b00">getById</span>(detailId);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (taskDetailInfo != <span style="color:#8b008b;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//æŸ¥å‡ºwms_ware_order_taskå·¥ä½œå–®çš„ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        Long id = to.<span style="color:#658b00">getId</span>();
</span></span><span style="display:flex;"><span>        WareOrderTaskEntity orderTaskInfo = wareOrderTaskService.<span style="color:#658b00">getById</span>(id);
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//ç²å–è¨‚å–®è™ŸæŸ¥è©¢è¨‚å–®ç‹€æ…‹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        String orderSn = orderTaskInfo.<span style="color:#658b00">getOrderSn</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//é ç¨‹æŸ¥è©¢è¨‚å–®ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        R orderData = orderFeignService.<span style="color:#658b00">getOrderStatus</span>(orderSn);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (orderData.<span style="color:#658b00">getCode</span>() == 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//è¨‚å–®æ•¸æ“šè¿”å›æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            OrderVo orderInfo = orderData.<span style="color:#658b00">getData</span>(<span style="color:#cd5555">&#34;data&#34;</span>, <span style="color:#8b008b;font-weight:bold">new</span> TypeReference&lt;OrderVo&gt;() {
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//åˆ¤æ–·è¨‚å–®ç‹€æ…‹æ˜¯å¦å·²å–æ¶ˆæˆ–è€…æ”¯ä»˜æˆ–è€…è¨‚å–®ä¸å­˜åœ¨
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// 1ã€è¨‚å–®ä¸å­˜åœ¨ï¼šè§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// 2ã€è¨‚å–®å­˜åœ¨ï¼Œä¸”è¨‚å–®ç‹€æ…‹æ˜¯å–æ¶ˆç‹€æ…‹ï¼šè§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">if</span> (orderInfo == <span style="color:#8b008b;font-weight:bold">null</span> || orderInfo.<span style="color:#658b00">getStatus</span>() == 4) {
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">// å·¥ä½œå–®ç‹€æ…‹å¿…é ˆæ˜¯ å·²é–å®š æ‰å¯ä»¥è§£é–ã€å› ç‚ºè§£é–æ–¹æ³•æ²’æœ‰åŠ äº‹å‹™ã€‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                <span style="color:#8b008b;font-weight:bold">if</span> (taskDetailInfo.<span style="color:#658b00">getLockStatus</span>() == 1) {
</span></span><span style="display:flex;"><span>                    unLockStock(detail.<span style="color:#658b00">getSkuId</span>(), detail.<span style="color:#658b00">getWareId</span>(), detail.<span style="color:#658b00">getSkuNum</span>(), detailId);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#8b008b;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//æ¶ˆæ¯æ‹’çµ•ä»¥å¾Œé‡æ–°æ”¾åœ¨éšŠåˆ—è£é¢ï¼Œè®“åˆ¥äººç¹¼çºŒæ¶ˆè²»è§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">//é ç¨‹èª¿ç”¨æœå‹™å¤±æ•—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">throw</span> <span style="color:#8b008b;font-weight:bold">new</span> RuntimeException(<span style="color:#cd5555">&#34;é ç¨‹èª¿ç”¨æœå‹™å¤±æ•—&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#8b008b;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//ç„¡éœ€è§£é–ã€å›æ»¾ç‹€æ…‹ã€‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * è§£é–åº«å­˜çš„æ–¹æ³•ã€è¨­è¨ˆDBï¼Œæ²’åŠ äº‹å‹™ã€‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">unLockStock</span>(Long skuId, Long wareId, Integer num, Long taskDetailId) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 1ã€åº«å­˜è§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        wareSkuDao.<span style="color:#658b00">unLockStock</span>(skuId, wareId, num);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 2ã€æ›´æ–°å·¥ä½œå–®çš„ç‹€æ…‹ ç‚ºå·²è§£é– 2
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        WareOrderTaskDetailEntity taskDetailEntity = <span style="color:#8b008b;font-weight:bold">new</span> WareOrderTaskDetailEntity();
</span></span><span style="display:flex;"><span>        taskDetailEntity.<span style="color:#658b00">setId</span>(taskDetailId);
</span></span><span style="display:flex;"><span>        taskDetailEntity.<span style="color:#658b00">setLockStatus</span>(2);
</span></span><span style="display:flex;"><span>        wareOrderTaskDetailService.<span style="color:#658b00">updateById</span>(taskDetailEntity);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ul>
<li>æŠ½å‡ºStockReleaseListener.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * ç›£è½æ­»ä¿¡éšŠåˆ—ï¼Œè§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@RabbitListener</span>(queues = <span style="color:#cd5555">&#34;stock.release.stock.queue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">StockReleaseListener</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> WareSkuService wareSkuService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * é€™å€‹æ˜¯ç›£è½æ­»ä¿¡æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * 1ã€åº«å­˜è‡ªå‹•è§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * ä¸‹è¨‚å–®æˆåŠŸï¼Œåº«å­˜é–å®šæˆåŠŸï¼Œæ¥ä¸‹ä¾†çš„æ¥­å‹™èª¿ç”¨å¤±æ•—ï¼Œå°è‡´è¨‚å–®å›æ»¾ã€‚ä¹‹å‰é–å®šçš„åº«å­˜å°±è¦è‡ªå‹•è§£é–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * 2ã€è¨‚å–®å¤±æ•—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * åº«å­˜é–å®šå¤±æ•—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * åªè¦è§£é–åº«å­˜çš„æ¶ˆæ¯å¤±æ•—ï¼Œä¸€å®šè¦å‘Šè¨´æœå‹™è§£é–å¤±æ•—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">handleStockLockedRelease</span>(StockLockedTo to, Message message, Channel channel) <span style="color:#8b008b;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#658b00">out</span>.<span style="color:#658b00">println</span>(<span style="color:#cd5555">&#34;******æ”¶åˆ°è§£é–åº«å­˜çš„å»¶æ™‚ä¿¡æ¯******ï¼Œæº–å‚™è§£é–&#34;</span> + to.<span style="color:#658b00">getDetailTo</span>().<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//ç•¶å‰æ¶ˆæ¯æ˜¯å¦è¢«ç¬¬äºŒæ¬¡åŠä»¥å¾Œï¼ˆé‡æ–°ï¼‰æ´¾ç™¼éä¾†äº†
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// Boolean redelivered = message.getMessageProperties().getRedelivered();
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">//è§£é–åº«å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            wareSkuService.<span style="color:#658b00">unlockStock</span>(to);
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// æ‰‹å‹•åˆªé™¤æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            channel.<span style="color:#658b00">basicAck</span>(message.<span style="color:#658b00">getMessageProperties</span>().<span style="color:#658b00">getDeliveryTag</span>(), <span style="color:#8b008b;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#8b008b;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// è§£é–å¤±æ•— å°‡æ¶ˆæ¯é‡æ–°æ”¾å›éšŠåˆ—ï¼Œè®“åˆ¥äººæ¶ˆè²»
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            channel.<span style="color:#658b00">basicReject</span>(message.<span style="color:#658b00">getMessageProperties</span>().<span style="color:#658b00">getDeliveryTag</span>(), <span style="color:#8b008b;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h4 id="ç™»å…¥æ””æˆªæ”¾è¡Œ">ç™»å…¥æ””æˆªæ”¾è¡Œ</h4>
<ul>
<li>
<p>é ç¨‹èª¿ç”¨æŸ¥è¨‚å–®ç‹€æ…‹æ™‚ï¼Œåˆè¢«ä¹‹å‰çš„æ””æˆªå™¨èªç‚ºæ˜¯æ²’ç™»å…¥ï¼Œå°è‡´è¢«è·³è½‰åˆ°ç™»å…¥é ï¼Œä½¿feignèª¿ç”¨å¤±æ•—</p>
</li>
<li>
<p>å¯ä»¥ç”¨<code>AntPathMatcher</code>åŒ¹é…urié‡å°ç‰¹å®šç¶²å€åšæ”¾è¡Œ</p>
</li>
<li>
<p>LoginUserInterceptor.java</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * ç™»å…¥æ””æˆªå™¨
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * å¾sessionä¸­ç²å–äº†ç™»å…¥ä¿¡æ¯ï¼ˆredisä¸­ï¼‰ï¼Œå°è£åˆ°äº†ThreadLocalä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">LoginUserInterceptor</span> <span style="color:#8b008b;font-weight:bold">implements</span> HandlerInterceptor {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">static</span> ThreadLocal&lt;MemberResponseTo&gt; loginUser = <span style="color:#8b008b;font-weight:bold">new</span> ThreadLocal&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">boolean</span> <span style="color:#008b45">preHandle</span>(HttpServletRequest request, HttpServletResponse response, Object handler) <span style="color:#8b008b;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String uri = request.<span style="color:#658b00">getRequestURI</span>();
</span></span><span style="display:flex;"><span>        AntPathMatcher antPathMatcher = <span style="color:#8b008b;font-weight:bold">new</span> AntPathMatcher();
</span></span><span style="display:flex;"><span>        <span style="color:#00688b;font-weight:bold">boolean</span> match = antPathMatcher.<span style="color:#658b00">match</span>(<span style="color:#cd5555">&#34;/order/order/status/**&#34;</span>, uri);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (match) {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h3 id="é—œé–‰è¨‚å–®">é—œé–‰è¨‚å–®</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>è¨‚å–®å‰µå»ºæˆåŠŸ<span style="color:#a61717;background-color:#e3d2d2">ï¼Œ</span>ç™¼é€ä¸€æ¢æ¶ˆæ¯çµ¦mqçš„å»¶æ™‚éšŠåˆ—
</span></span><span style="display:flex;"><span>1<span style="color:#a61717;background-color:#e3d2d2">ã€</span>ç•¶ è¨‚å–®æ•¸æ“šæ˜¯ 0 å¾…ä»˜æ¬¾<span style="color:#a61717;background-color:#e3d2d2">ï¼Œ</span>ä¿®æ”¹DB è¨‚å–®ç‹€æ…‹ç‚º 4 å–æ¶ˆç‹€æ…‹
</span></span><span style="display:flex;"><span>2<span style="color:#a61717;background-color:#e3d2d2">ã€</span>é—œå–®æ¯”è§£é–æ—©<span style="color:#a61717;background-color:#e3d2d2">ï¼Œ</span>æ‰€ä»¥è§£é–çš„æ™‚å€™æª¢æŸ¥è¨‚å–®ç‹€æ…‹ç‚º4çš„å°±å¯ä»¥è§£é–æ‰äº†
</span></span><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * å®šæ™‚é—œé–‰è¨‚å–®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> *
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@RabbitListener</span>(queues = <span style="color:#cd5555">&#34;order.release.order.queue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">OrderCloseListener</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> OrderService orderService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@RabbitHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">listener</span>(OrderEntity orderEntity, Channel channel, Message message) <span style="color:#8b008b;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#658b00">out</span>.<span style="color:#658b00">println</span>(<span style="color:#cd5555">&#34;æ”¶åˆ°éæœŸçš„è¨‚å–®ä¿¡æ¯ï¼Œæº–å‚™é—œé–‰è¨‚å–®&#34;</span> + orderEntity.<span style="color:#658b00">getOrderSn</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            orderService.<span style="color:#658b00">closeOrder</span>(orderEntity);
</span></span><span style="display:flex;"><span>            channel.<span style="color:#658b00">basicAck</span>(message.<span style="color:#658b00">getMessageProperties</span>().<span style="color:#658b00">getDeliveryTag</span>(),<span style="color:#8b008b;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#8b008b;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            channel.<span style="color:#658b00">basicReject</span>(message.<span style="color:#658b00">getMessageProperties</span>().<span style="color:#658b00">getDeliveryTag</span>(),<span style="color:#8b008b;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * é—œé–‰è¨‚å–®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * @param orderEntity
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">closeOrder</span>(OrderEntity orderEntity) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//é—œé–‰è¨‚å–®ä¹‹å‰å…ˆæŸ¥è©¢ä¸€ä¸‹æ•¸æ“šåº«ï¼Œåˆ¤æ–·æ­¤è¨‚å–®ç‹€æ…‹æ˜¯å¦å·²æ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        OrderEntity orderInfo = <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">getOne</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;OrderEntity&gt;().
</span></span><span style="display:flex;"><span>                eq(<span style="color:#cd5555">&#34;order_sn&#34;</span>,orderEntity.<span style="color:#658b00">getOrderSn</span>()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (orderInfo.<span style="color:#658b00">getStatus</span>().<span style="color:#658b00">equals</span>(OrderStatusEnum.<span style="color:#658b00">CREATE_NEW</span>.<span style="color:#658b00">getCode</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//ä»£ä»˜æ¬¾ç‹€æ…‹é€²è¡Œé—œå–®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            OrderEntity orderUpdate = <span style="color:#8b008b;font-weight:bold">new</span> OrderEntity();
</span></span><span style="display:flex;"><span>            orderUpdate.<span style="color:#658b00">setId</span>(orderInfo.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>            orderUpdate.<span style="color:#658b00">setStatus</span>(OrderStatusEnum.<span style="color:#658b00">CANCLED</span>.<span style="color:#658b00">getCode</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">updateById</span>(orderUpdate);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// ç™¼é€æ¶ˆæ¯çµ¦MQ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            OrderTo orderTo = <span style="color:#8b008b;font-weight:bold">new</span> OrderTo();
</span></span><span style="display:flex;"><span>            BeanUtils.<span style="color:#658b00">copyProperties</span>(orderInfo, orderTo);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">//TODO ç¢ºä¿æ¯å€‹æ¶ˆæ¯ç™¼é€æˆåŠŸï¼Œçµ¦æ¯å€‹æ¶ˆæ¯åšå¥½æ—¥èªŒè¨˜éŒ„ï¼Œ(çµ¦æ•¸æ“šåº«ä¿å­˜æ¯ä¸€å€‹è©³ç´°ä¿¡æ¯)ä¿å­˜æ¯å€‹æ¶ˆæ¯çš„è©³ç´°ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                rabbitTemplate.<span style="color:#658b00">convertAndSend</span>(<span style="color:#cd5555">&#34;order-event-exchange&#34;</span>, <span style="color:#cd5555">&#34;order.release.other&#34;</span>, orderTo);
</span></span><span style="display:flex;"><span>            } <span style="color:#8b008b;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">//TODO å®šæœŸæƒææ•¸æ“šåº«ï¼Œé‡æ–°ç™¼é€å¤±æ•—çš„æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h4 id="ä¿®å¾©bug">ä¿®å¾©BUG</h4>
<ul>
<li>è¨‚å–®é—œé–‰å»¶é²å°è‡´åº«å­˜æœªè§£é–ï¼Œä¸¦ä¸”æ¶ˆæ¯ä¹Ÿæ¶ˆè²»æ‰äº†</li>
</ul>
<p><img src="image-20220130221635906.png" alt="image-20220130221635906"></p>
<ul>
<li>
<p>æœƒå°è‡´è©²æ¢åº«å­˜æ°¸é ç„¡æ³•è§£é–äº†ï¼Œè¨‚å–®é—œé–‰çš„æ¶ˆæ¯å»¶é²ï¼Œè¨‚å–®ç‹€æ…‹é‚„æ²’ä¿®æ”¹ç‚º4ï¼Œå°è‡´åº«å­˜ä¸è§£é–</p>
</li>
<li>
<p>è§£æ³•: å‰µå»ºä¸€å€‹ç¶å®šé—œä¿‚ï¼Œè¨‚å–®çš„äº¤æ›æ©Ÿç¶å®šåº«å­˜é‡‹æ”¾çš„éšŠåˆ—ï¼Œç•¶è¨‚å–®é—œé–‰æˆåŠŸçµ¦ stock.release.stock.queueåº«å­˜çš„é‡‹æ”¾éšŠåˆ—ä¹Ÿç™¼é€ä¸€æ¢æ¶ˆæ¯</p>
</li>
</ul>
<p><img src="image-20220130221557106.png" alt="image-20220130221557106"></p>
<h2 id="å¯é æ€§">å¯é æ€§</h2>
<blockquote>
<p>ç”±æ–¼æŠŠäº‹å‹™è½‰æ›æˆæ¶ˆæ¯éšŠåˆ—çš„æ¨¡å¼ï¼Œæ‰€ä»¥å¿…é ˆä¿è­‰æ¶ˆæ¯æœ¬èº«æ˜¯å¯é çš„</p>
</blockquote>
<h3 id="é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±">é˜²æ­¢æ¶ˆæ¯ä¸Ÿå¤±</h3>
<ul>
<li>åšå¥½å®¹éŒ¯æ–¹æ³•(try-catchï¼Œä¾‹å¦‚å¤±æ•—å¾Œé‡è©¦)ï¼Œä¸¦ä¸”è¨˜éŒ„æ—¥èªŒåˆ°DBï¼Œæ¯å€‹æ¶ˆæ¯æ˜¯å¦æœ‰å‚³åˆ°Brokeréƒ½æ‡‰è©²è¢«è¨˜éŒ„ï¼Œå®šæœŸæƒæDBæœªæˆåŠŸçš„æ¶ˆæ¯é‡å°æ€§é‡ç™¼</li>
<li>æ¶ˆæ¯æŠµé”Brokerå¾Œï¼Œè¦æŒä¹…åŒ–(å¯«å…¥ç¡¬ç¢Ÿ)</li>
<li>å¼•å…¥è¨Šæ¯ç¢ºèªï¼Œpublisher confirmCallback(ç¢ºå®šæœ‰åˆ°Broker)èˆ‡returnCallback(å¾äº¤æ›æ©Ÿå»åˆ°éšŠåˆ—å¤±æ•—ï¼Œä¿®æ”¹DBä¸­æ—¥è¨˜ç‹€æ…‹)
<ul>
<li><a href="https://yoziming.github.io/post/220204-gulimall-18-rabbitmq/#%e8%a8%8a%e6%81%af%e7%a2%ba%e8%aa%8d">https://yoziming.github.io/post/220204-gulimall-18-rabbitmq/#%e8%a8%8a%e6%81%af%e7%a2%ba%e8%aa%8d</a></li>
</ul>
</li>
<li>æ‰‹å‹•Ackï¼Œåšå®Œä½œæ¥­æ‰å°‡æ¶ˆæ¯æ¶ˆè²»æ‰</li>
</ul>
<h3 id="é˜²æ­¢æ¶ˆæ¯é‡è¤‡">é˜²æ­¢æ¶ˆæ¯é‡è¤‡</h3>
<blockquote>
<p>ä¾‹å¦‚ç¢ºå¯¦åšå®Œä½œæ¥­äº†ï¼Œçµæœackæ™‚ç•¶æ©Ÿï¼Œå°è‡´æ¶ˆæ¯åˆè®Šå›ready</p>
</blockquote>
<ul>
<li>æ¶ˆè²»æ¶ˆæ¯çš„æ¥å£æ‡‰è©²æ˜¯è¦“ç­‰æ€§çš„ï¼Œå¤šæ¬¡èª¿ç”¨çµæœä¸€è‡´ï¼Œä¾‹å¦‚å·¥ä½œå–®çš„ç‹€æ…‹æ¨™ç¤ºå¯ä»¥åœ¨å…§éƒ¨åˆ¤æ–·æ˜¯å¦è¢«åšé</li>
<li>ä½¿ç”¨é˜²é‡è¡¨(redisæˆ–mySQL)ï¼Œç™¼é€çš„æ¶ˆæ¯æ¥­å‹™æœ‰å”¯ä¸€æ¨™ç¤ºï¼Œåšéå°±ä¸ç”¨å†åš</li>
<li>rabbitMQçš„messageæœ¬èº«æœ‰ä¸€å€‹redeliveredå±¬æ€§ï¼Œå¯ä»¥æ¨™ç¤ºæ¶ˆæ¯è‡ªå·±æ˜¯å¦è¢«äºŒæ¬¡ä»¥ä¸ŠæŠ•é</li>
<li>ä½†è¦æ³¨æ„æ¶ˆæ¯çš„rejectæˆ–é‡è©¦æœ€å¥½æœ‰ä¸€å€‹é–“éš”ï¼Œä¹‹å‰æˆ‘å¡åœ¨ç˜‹ç‹‚é‡è©¦ç›´æ¥æŠŠCPUåƒçˆ†</li>
</ul>
<h3 id="é˜²æ­¢æ¶ˆæ¯ç©å£“">é˜²æ­¢æ¶ˆæ¯ç©å£“</h3>
<blockquote>
<p>æ¶ˆè²»è€…ç«¯ç•¶æ©Ÿæˆ–å¤ªå¼±ï¼Œæˆ–æ˜¯ç™¼é€è€…æµé‡å¤ªå¤§éƒ½æœƒé€ æˆç©å£“</p>
</blockquote>
<ul>
<li>æ¶ˆæ¯ç©å£“æœƒå°è‡´MQæ€§èƒ½ä¸‹é™ï¼Œæƒ¡æ€§å¾ªç’°</li>
<li>å½ˆæ€§æ“´å®¹ï¼Œä¸Šç·šæ›´å¤šæ¶ˆè²»è€…</li>
<li>æ¶ˆæ¯å…¥åº«ï¼Œä¸Šç·šä¸€å€‹è‡¨æ™‚æ¶ˆè²»éšŠåˆ—çš„æœå‹™ï¼Œæ‰¹é‡å°‡æ¶ˆæ¯å–å‡ºåˆ°DBï¼Œé¡å¤–é›¢ç·šè™•ç†</li>
</ul>
<h1 id="å°çµ">å°çµ</h1>
<ul>
<li>å»¶é²éšŠåˆ—ï¼ŒæŠŠè¨‚å–®è·Ÿé–åº«å­˜é€™å€‹è¡Œç‚ºè½‰æ›æˆæ¶ˆæ¯ç™¼å¾€MQ</li>
<li>å¾ŒçºŒè¦åšçš„äº‹ï¼Œç”¨Listenerå¾MQéšŠåˆ—ä¸­å–å‡ºã€‚åˆ©ç”¨äº¤æ›æ©Ÿèˆ‡è·¯ç”±éµåŒ¹é…çš„è¦å‰‡ï¼Œé›–ç„¶å¯èƒ½æœ‰å»¶é²ï¼Œä½†ç¢ºä¿æœ‰ä»»ä½•ç’°ç¯€å¤±æ•—ï¼Œæ•´é«”éƒ½èƒ½äº‹å‹™å›æ»¾</li>
<li>æ„Ÿè¦ºé›£åº¦éé«˜ï¼Œæœ‰é»è½å¤©æ›¸çš„æ„Ÿè¦ºäº†ï¼Œå¤§è‡´èƒ½ç†è§£ä½†æ˜¯æ•²codeéƒ¨åˆ†éƒ½æ˜¯å›«åœ‡åæ£—äº†</li>
</ul>
<h2 id="feignèª¿ç”¨å ±éŒ¯400-bad-reques">Feignèª¿ç”¨å ±éŒ¯400 Bad Reques</h2>
<blockquote>
<p>ç´€éŒ„ä¸€å€‹DEBUGç¶“é©—</p>
</blockquote>
<pre tabindex="0"><code>feign.FeignException$BadRequest: [400] during ....
</code></pre><ul>
<li>Feignèª¿ç”¨å‡ºç¾400ä¸€èˆ¬éƒ½æ˜¯clientå’Œcontrollerçš„åƒæ•¸åä¸åŒ¹é…</li>
<li>ç¢ºèªä¸‹å…©å€‹ä»‹é¢çš„åƒæ•¸åæ˜¯å¦ä¸€æ¨£ï¼Œå†ç¢ºèªä¸‹å…¥åƒæ˜¯å¦ç‚ºç©º
<ul>
<li>æˆ‘å°±æ˜¯æœ‰ä¸€å€‹å€¼ä¹‹å‰æ¸¬è©¦æ™‚å¼„æˆNULLäº†ï¼Œç–‘æƒ‘å¥½ä¹…</li>
</ul>
</li>
</ul>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">ä¸Šæ¬¡ä¿®æ”¹æ–¼ 2022-02-07</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://yoziming.github.io/post/220208-gulimall-22-pay/">
			ä¸‹ä¸€ç¯‡<br>ä¸²æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜
                </a>
                
                
                
                <a class="older-posts" href="https://yoziming.github.io/post/220207-alibaba-java-guide/">
			ä¸Šä¸€ç¯‡<br>é˜¿é‡Œå·´å·´Javaé–‹ç™¼æ‰‹å†Š
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="waline"></div>
<script>
    new Waline({
        el: '#waline',
        path: location.pathname,
        serverURL: "https://waline-pn38gfwbz-yoziming.vercel.app/" ,
		lang: 'en-US',
		visitor: true,
		meta: ['nick', 'mail'],
    });
    </script>



            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
ç§»æ¤è‡ª <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Yoziming
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
